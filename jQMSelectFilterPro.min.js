/* 
jQMSelectFilterPro 0.0
https://github.com/dlwelch/jQuery-widgets
Copyright Â© 2015 Dedra L. Welch 
Licensed MIT
*/
$.widget("custom.jqmselectfilterpro",{options:{searchprompt:null,maxitems:0,categoryfield:null,filterReveal:!1,source:null,searchfields:[],defaultvalue:[]},_selectedvalue:null,_visibleitems:0,value:function(){return"undefined"===$.type(this._selectedvalue)?null:this._selectedvalue},selectitem:function(a){if($.isArray(a)){var c=this,d=$.grep(this.options.source.items,function(b,f){return c._compareObjectKeys(b,a)});0<d.length?(this.element.val(d[0].jqmselectfilterprovalue),$(this.element).find("option:first").html(d[0].label),
this._selectedvalue=d[0]):(this.element.val(this.options.searchprompt),$(this.element).find("option:first").html(this.options.searchprompt),this._selectedvalue=null)}},_create:function(){var a=this,c=document.createElement("option");$(c).html(a.options.searchprompt);a.element.append(c);var d="",b;$.each(a.options.source.items,function(c,e){e.jqmselectfilterprovalue=parseInt(c)+1;e.category!=d&&null!=a.options.categoryfield&&(b=document.createElement("optgroup"),$(b).attr("label",e.category),a.element.append(b),
d=e.category);var g=document.createElement("option");$(g).attr("value",parseInt(c)+1).html(e.label).attr("data-filtertext",a._getfiltertext(e)).addClass("jqmselectfilterprosearchable");null!=a.options.categoryfield?$(b).append(g):a.element.append(g)});this.selectitem(this.options.defaultvalue);this.element.on("selectmenucreate",function(c){var e,b=$(c.target);c=$("#"+b.attr("id")+"-menu");var d=c.jqmData("filter-form");d||(e=$("<input data-type='search'></input>"),d=$("<form style='padding-bottom:1em;'></form>").append(e),
e.textinput(),c.before(d).jqmData("filter-form",d),d.jqmData("listview",c));a.element.on("change",function(c){a._selectedvalue=a.options.source.items[b.find(":selected").attr("value")];$(this).find("option:first").html(a._selectedvalue.label);$("#"+a.element.attr("id")+"-listbox").find("h1").html(a._selectedvalue.label)});$("#"+a.element.attr("id")+"-listbox-popup").on("popupafteropen",function(){$("input").focus()});$.mobile.document.on("pagecontainerbeforeshow",function(c,b){if(b.toPage.attr("id")==
a.element.attr("id")+"-dialog"){var d,e;d=b.toPage.find("ul");e=d.jqmData("filter-form");b.toPage.jqmData("listview",d);d.before(e);b.toPage.find("div.ui-title").html($("#"+a.element.attr("id")).find(":selected").text())}}).on("pagecontainerhide",function(c,b){if(b.prevPage.attr("id")==a.element.attr("id")+"-dialog"){var d,e;d=b.prevPage.jqmData("listview");e=d.jqmData("filter-form");d.before(e)}}).on("pagecontainershow",function(b,c){c.toPage.attr("id")==a.element.attr("id")+"-dialog"&&$("input").focus()});
b.filterable({input:e,children:".jqmselectfilterprosearchable",filterCallback:function(c,b){if(0<a.options.maxitems&&a._visibleitems>=a.options.maxitems||a.options.filterReveal&&""==b)return!0;var d=-1===(""+($.mobile.getAttribute(this,"filtertext")||$(this).text())).toLowerCase().indexOf(b);d||(a._visibleitems+=1);return d}}).on("filterablebeforefilter",function(){a._visibleitems=0}).on("filterablefilter",function(){var b=parseInt(a.element.find(":selected").attr("value"));$("#"+a.element.attr("id")+
"-listbox").find("li[aria-selected='true']").attr("aria-selected",!1).find("a").removeClass("ui-btn-active");$("#"+a.element.attr("id")+"-listbox").find("li[data-option-index='"+b+"']").attr("aria-selected",!0).find("a").addClass("ui-btn-active");$("#"+a.element.attr("id")+"-dialog").find("li[aria-selected='true']").attr("aria-selected",!1).find("a").removeClass("ui-btn-active");$("#"+a.element.attr("id")+"-dialog").find("li[data-option-index='"+b+"']").attr("aria-selected",!0).find("a").addClass("ui-btn-active")})});
this.element.selectmenu()},_getfiltertext:function(a){var c="";$.each(this.options.searchfields,function(d,b){c+=a[b]});return c},_compareObjectKeys:function(a,c){for(var d=c.length,b=0;b<d;b++){var f=!0,e;for(e in c[b])c[b].hasOwnProperty(e)&&a[e]!=c[b][e]&&(f=!1);if(1==f)return!0}return!1}});
